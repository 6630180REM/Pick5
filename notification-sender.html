<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joe's Pick 5 - Notification Sender</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #333;
            color: white;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #444;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        h1 {
            color: #478fdf;
            text-align: center;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #666;
            border-radius: 5px;
            background-color: #555;
            color: white;
            font-size: 16px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        button {
            background-color: #478fdf;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background-color: #3a7bc8;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .success {
            background-color: #4CAF50;
        }
        .error {
            background-color: #f44336;
        }
        .token-list {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            background-color: #555;
            padding: 10px;
            border-radius: 5px;
        }
        .token-item {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #666;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background-color: #555;
            cursor: pointer;
        }
        .tab.active {
            background-color: #478fdf;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .auth-container {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Joe's Pick 5 - Notification Sender</h1>
        
        <div class="tabs">
            <div class="tab active" data-tab="send">Send Notification</div>
            <div class="tab" data-tab="tokens">Manage Tokens</div>
            <div class="tab" data-tab="settings">Settings</div>
        </div>
        
        <div class="tab-content active" id="send-tab">
            <div class="form-group">
                <label for="notification-title">Notification Title:</label>
                <input type="text" id="notification-title" placeholder="Enter notification title" value="Joe's Pick 5">
            </div>
            
            <div class="form-group">
                <label for="notification-body">Notification Body:</label>
                <textarea id="notification-body" placeholder="Enter notification message"></textarea>
            </div>
            
            <div class="form-group">
                <label for="notification-type">Notification Type:</label>
                <select id="notification-type">
                    <option value="all">Send to All Users</option>
                    <option value="single">Send to Single Token</option>
                </select>
            </div>
            
            <div class="form-group" id="single-token-group" style="display: none;">
                <label for="single-token">Device Token:</label>
                <input type="text" id="single-token" placeholder="Enter device token">
            </div>
            
            <button id="send-notification">Send Notification</button>
            
            <div id="status" class="status" style="display: none;"></div>
        </div>
        
        <div class="tab-content" id="tokens-tab">
            <button id="load-tokens">Load Registered Tokens</button>
            <div class="token-list" id="token-list"></div>
        </div>
        
        <div class="tab-content" id="settings-tab">
            <div class="auth-container">
                <div class="form-group">
                    <label for="firebase-api-key">Firebase API Key:</label>
                    <input type="text" id="firebase-api-key" placeholder="Enter Firebase API Key" value="AIzaSyB5r_KL2eKVFd66VQU_5pznKrVHa9xzCfc">
                </div>
                
                <div class="form-group">
                    <label for="firebase-project-id">Firebase Project ID:</label>
                    <input type="text" id="firebase-project-id" placeholder="Enter Firebase Project ID" value="joespick5push">
                </div>
                
                <div class="form-group">
                    <label for="admin-password">Admin Password:</label>
                    <input type="text" id="admin-password" placeholder="Set admin password">
                </div>
                
                <button id="save-settings">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>

        const provider = new firebase.auth.GithubAuthProvider();
provider.setCustomParameters({
  'allow_signup': 'false'
});

// Add a login button to your UI
document.getElementById('login-button').addEventListener('click', async () => {
  try {
    const result = await firebase.auth().signInWithPopup(provider);
    // User is now logged in
    console.log("Logged in:", result.user.displayName);
    // Enable the notification sending UI
  } catch (error) {
    console.error("Authentication error:", error);
  }
});

        async function sendNotification(title, body, token = null) {
  try {
    // Get the current user's ID token
    const user = firebase.auth().currentUser;
    if (!user) {
      throw new Error("User not authenticated");
    }
    
    const idToken = await user.getIdToken();
    
    // Use the Firebase REST API to send the notification
    const response = await fetch(`https://fcm.googleapis.com/v1/projects/joespick5push/messages:send`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${idToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: {
          token: token, // For a single device
          topic: 'all', // For all devices subscribed to a topic
          notification: {
            title: title,
            body: body
          },
          webpush: {
            fcm_options: {
              link: 'https://6630180rem.github.io/Pick5/'
            }
          }
        }
      })
    });
    
    const result = await response.json();
    return result;
  } catch (error) {
    console.error("Error sending notification:", error);
    throw error;
  }
}
        
        
        // Firebase configuration
        let firebaseConfig = {
            apiKey: "AIzaSyB5r_KL2eKVFd66VQU_5pznKrVHa9xzCfc",
            authDomain: "joespick5push.firebaseapp.com",
            projectId: "joespick5push",
            storageBucket: "joespick5push.firebasestorage.app",
            messagingSenderId: "783669343677",
            appId: "1:783669343677:web:c1f72d2a2a58b0349a4ed4"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Load settings from localStorage
        function loadSettings() {
            const apiKey = localStorage.getItem('firebaseApiKey');
            const projectId = localStorage.getItem('firebaseProjectId');
            const adminPassword = localStorage.getItem('adminPassword');
            
            if (apiKey) document.getElementById('firebase-api-key').value = apiKey;
            if (projectId) document.getElementById('firebase-project-id').value = projectId;
            if (adminPassword) document.getElementById('admin-password').value = adminPassword;
        }
        
        // Save settings to localStorage
        document.getElementById('save-settings').addEventListener('click', function() {
            const apiKey = document.getElementById('firebase-api-key').value;
            const projectId = document.getElementById('firebase-project-id').value;
            const adminPassword = document.getElementById('admin-password').value;
            
            localStorage.setItem('firebaseApiKey', apiKey);
            localStorage.setItem('firebaseProjectId', projectId);
            localStorage.setItem('adminPassword', adminPassword);
            
            showStatus('Settings saved successfully!', 'success');
        });
        
        // Load tokens from Firestore
        document.getElementById('load-tokens').addEventListener('click', async function() {
            const tokenList = document.getElementById('token-list');
            tokenList.innerHTML = 'Loading tokens...';
            
            try {
                const snapshot = await db.collection('fcmTokens').get();
                
                if (snapshot.empty) {
                    tokenList.innerHTML = 'No tokens found.';
                    return;
                }
                
                tokenList.innerHTML = '';
                snapshot.forEach(doc => {
                    const tokenData = doc.data();
                    const tokenItem = document.createElement('div');
                    tokenItem.className = 'token-item';
                    tokenItem.innerHTML = `
                        <div><strong>Token:</strong> ${tokenData.token}</div>
                        <div><strong>Device:</strong> ${tokenData.device?.platform || 'Unknown'}</div>
                        <div><strong>Last Active:</strong> ${tokenData.lastActive ? new Date(tokenData.lastActive.toDate()).toLocaleString() : 'Unknown'}</div>
                        <button class="send-to-token" data-token="${tokenData.token}">Send Test</button>
                    `;
                    tokenList.appendChild(tokenItem);
                });
                
                // Add event listeners to the "Send Test" buttons
                document.querySelectorAll('.send-to-token').forEach(button => {
                    button.addEventListener('click', function() {
                        const token = this.getAttribute('data-token');
                        document.getElementById('notification-type').value = 'single';
                        document.getElementById('single-token').value = token;
                        document.querySelector('[data-tab="send"]').click();
                    });
                });
                
            } catch (error) {
                console.error('Error loading tokens:', error);
                tokenList.innerHTML = `Error: ${error.message}`;
            }
        });
        
        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Hide all tab content
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                // Show the corresponding tab content
                document.getElementById(`${this.getAttribute('data-tab')}-tab`).classList.add('active');
            });
        });
        
        // Show/hide single token input based on notification type
        document.getElementById('notification-type').addEventListener('change', function() {
            const singleTokenGroup = document.getElementById('single-token-group');
            singleTokenGroup.style.display = this.value === 'single' ? 'block' : 'none';
        });
        
        // Function to show status message
        function showStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = 'status ' + type;
            statusElement.style.display = 'block';
            
            // Hide status after 5 seconds
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }
        
        // Send notification
        document.getElementById('send-notification').addEventListener('click', async function() {
            const title = document.getElementById('notification-title').value;
            const body = document.getElementById('notification-body').value;
            const notificationType = document.getElementById('notification-type').value;
            
            if (!title || !body) {
                showStatus('Please enter both title and body', 'error');
                return;
            }
            
            try {
                let tokens = [];
                
                if (notificationType === 'all') {
                    // Get all tokens from Firestore
                    const snapshot = await db.collection('fcmTokens').get();
                    tokens = snapshot.docs.map(doc => doc.data().token);
                } else {
                    // Get single token from input
                    const singleToken = document.getElementById('single-token').value;
                    if (!singleToken) {
                        showStatus('Please enter a device token', 'error');
                        return;
                    }
                    tokens = [singleToken];
                }
                
                if (tokens.length === 0) {
                    showStatus('No tokens found to send notification', 'error');
                    return;
                }
                
                // Send notification using Firebase Cloud Messaging REST API
                const apiKey = document.getElementById('firebase-api-key').value;
                const projectId = document.getElementById('firebase-project-id').value;
                
                // Use FCM HTTP v1 API
                const fcmEndpoint = `https://fcm.googleapis.com/v1/projects/${projectId}/messages:send`;
                
                // Get access token (this is a simplified version, you'll need to implement proper authentication)
                const response = await fetch('https://www.googleapis.com/oauth2/v4/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        grant_type: 'refresh_token',
                        client_id: 'your-client-id',
                        client_secret: 'your-client-secret',
                        refresh_token: 'your-refresh-token'
                    })
                });
                
                const data = await response.json();
                const accessToken = data.access_token;
                
                // Send notification to each token
                for (const token of tokens) {
                    await fetch(fcmEndpoint, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: {
                                token: token,
                                notification: {
                                    title: title,
                                    body: body
                                },
                                webpush: {
                                    fcm_options: {
                                        link: 'https://6630180rem.github.io/Pick5/'
                                    }
                                }
                            }
                        })
                    });
                }
                
                showStatus(`Notification sent to ${tokens.length} device(s)`, 'success');
                
            } catch (error) {
                console.error('Error sending notification:', error);
                showStatus(`Error: ${error.message}`, 'error');
            }
        });
        
        // Load settings on page load
        document.addEventListener('DOMContentLoaded', loadSettings);
    </script>
</body>
</html>

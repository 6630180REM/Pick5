<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Joe's Pick 5">
    <meta name="application-name" content="Joe's Pick 5">
    <meta name="theme-color" content="#333">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="icon" type="image/png" sizes="32x32" href="Pick5Logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="Pick5Logo.png">

    <link rel="apple-touch-icon" href="Pick5Logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="Pick5Logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="Pick5Logo.png">
    <link rel="apple-touch-icon" sizes="167x167" href="Pick5Logo.png">

    <link rel="shortcut icon" href="Pick5Logo.png">

    <link rel="manifest" href="manifest.json">

    <title>Joe's Pick 5</title>
    <style>
        html, body {
            background-color: #333 !important;
            margin: 0;
            padding: 0;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
            overscroll-behavior: none;
        }
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-text-size-adjust: none;
            text-size-adjust: none;
        }
        input, textarea {
            font-size: 16px !important;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
            overflow: auto;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
        }
        #install-banner {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #333;
            color: white;
            text-align: center;
            padding: 10px;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        #install-banner button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 8px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            overflow: hidden;
            background: linear-gradient(to top, #333 3%, rgba(51, 51, 51, 0.8) 5%, rgba(51, 51, 51, 0) 7%, rgba(52, 51, 51, 0) 50%, rgba(51, 51, 51, 0.8) 90%, #333 99%),
                        url(https://img.freepik.com/premium-photo/3d-rendering-empty-american-football-field-with-stadium_493806-8391.jpg?semt=ais_hybrid);
            color: white;
            padding: 0px;
            background-attachment: fixed;
            background-repeat: round;
            background-size: cover;
        }
        #preloader-text {
            font-size: 7rem;
            font-weight: bold;
            color: transparent;
            position: relative;
            text-align: center;
            -webkit-text-stroke: 7px #478fdf;
            line-height: .9;
        }
        #preloader-text::before {
            content: "JOE'S\A PICK 5";
            white-space: pre;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 0;
            overflow: hidden;
            color: #478fdf;
            border-bottom: 3px solid white;
            animation: fill-text-bottom-up 3s linear forwards;
            padding: 0px;
            -webkit-text-stroke: 7px #478fdf;
        }
        @keyframes fill-text-bottom-up {
            0% {height: 0;}
            100% {height: 100%;}
        }
    </style>
</head>
<body>
    <div id="preloader">
        <div id="preloader-text">JOE'S<br>PICK 5</div>
    </div>

    <div id="install-banner">
        <p>Add to Home Screen for the best experience</p>
        <button id="install-button">Install</button>
        <button id="dismiss-button">Dismiss</button>
    </div>

    <iframe frameborder="0" scrolling="yes" allowfullscreen="yes" src="https://script.google.com/macros/s/AKfycbwuZM7KGKnS7jnpM2YN9W_AgTMqA0qJGw99K3MIUNxzI1tnh3YK76AhgeCfh2Wc7pTd/exec"></iframe>

    <button id="reset-notifications" style="
                position: fixed;
                bottom: 20px;
                right: 20px;
                background-color: #478fdf;
                color: white;
                border: none;
                padding: 10px 18px;
                border-radius: 4px;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                z-index: 1001;">Reset Notifications</button>

    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
    let messaging;
    let db;

    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyB5r_KL2eKVFd66VQU_5pznKrVHa9xzCfc",
        authDomain: "joespick5push.firebaseapp.com",
        projectId: "joespick5push",
        storageBucket: "joespick5push.firebasestorage.app",
        messagingSenderId: "783669343677",
        appId: "1:783669343677:web:d3a43a1a58b920ba9a4ed4",
        measurementId: "G-HNPLN4XZ44"
    };

    function setupFirebaseAndNotifications() {
        // Initialize Firebase (with check to prevent duplicate initialization)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        messaging = firebase.messaging();
        db = firebase.firestore();

        // Register service worker first
        if ('serviceWorker' in navigator) {
            const swPath = window.location.pathname.includes('/Pick5/')
                ? '/Pick5/firebase-messaging-sw.js'
                : './firebase-messaging-sw.js';

            console.log('Attempting to register service worker at:', swPath);

            navigator.serviceWorker.register(swPath)
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                    initializeNotifications(registration);
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error.message);
                });
        } else {
            console.log('Service workers not supported');
        }
    }

    function initializeNotifications(registration) {
        navigator.serviceWorker.addEventListener('message', event => {
            if (event.data && event.data.type === 'tokenRefresh') {
                console.log('Token refresh detected');
                refreshToken(registration);
            }
        });

        function requestPermission() {
            Notification.requestPermission()
                .then(permission => {
                    if (permission === 'granted') {
                        console.log('Notification permission granted.');
                        messaging.getToken({
                            vapidKey: 'BOM3KFfemC5lGnsF28N-_UGA7H9esoOm5gp0_Eg45HMqaMqviLx_bcAonVaZe-c0GwSFwfwe7-fJVP1n8h1iAAU',
                            serviceWorkerRegistration: registration
                        }).then(token => {
                            console.log('Device token:', token);
                            saveTokenToFirestore(token);
                            showSuccessMessage('Notifications enabled successfully!');
                        }).catch(error => {
                            console.error('Error getting token:', error);
                        });
                    } else {
                        console.log('Notification permission denied.');
                        localStorage.setItem('notificationPermissionDenied', 'true');
                    }
                }).catch(error => {
                    console.error('Error requesting permission:', error);
                });
        }

        function refreshToken(registration) {
            messaging.getToken({
                vapidKey: 'BOM3KFfemC5lGnsF28N-_UGA7H9esoOm5gp0_Eg45HMqaMqviLx_bcAonVaZe-c0GwSFwfwe7-fJVP1n8h1iAAU',
                serviceWorkerRegistration: registration
            }).then(refreshedToken => {
                console.log('Token refreshed:', refreshedToken);
                saveTokenToFirestore(refreshedToken);
            }).catch(err => {
                console.error('Unable to refresh token:', err);
            });
        }
    }

    async function saveTokenToFirestore(token) {
        if (!token) {
            console.error('No token provided to saveTokenToFirestore');
            return;
        }

        const deviceId = generateDeviceId();

        try {
            const existingDevice = await db.collection('devices')
                .where('deviceId', '==', deviceId)
                .get();

            if (!existingDevice.empty) {
                const doc = existingDevice.docs[0];
                await db.collection('devices').doc(doc.id).update({
                    token: token,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                });
                console.log('Device token updated in Firestore');
            } else {
                await db.collection('devices').add({
                    deviceId: deviceId,
                    token: token,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                });
                console.log('New device record created in Firestore');
            }

            localStorage.setItem('fcmToken', token);
            localStorage.setItem('deviceId', deviceId);
        } catch (error) {
            console.error('Error saving token to Firestore:', error);
        }
    }

    function generateDeviceId() {
        const deviceData = [
            navigator.userAgent,
            navigator.language,
            screen.width,
            screen.height,
            new Date().getTimezoneOffset()
        ].join('|');

        let hash = 0;
        for (let i = 0; i < deviceData.length; i++) {
            const char = deviceData.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return 'device_' + Math.abs(hash);
    }

    // ✅ Moved this outside so it can be used globally
    function showSuccessMessage(message) {
        const successDiv = document.createElement('div');
        successDiv.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #478fdf;
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1002;
            font-family: Arial, sans-serif;
            animation: fade-in 0.3s ease-in-out;
        `;
        successDiv.textContent = message;
        document.body.appendChild(successDiv);
        setTimeout(() => {
            successDiv.style.animation = 'fade-out 0.3s ease-in-out';
            setTimeout(() => successDiv.remove(), 300);
        }, 3000);
    }

    function resetNotifications() {
        messaging.deleteToken()
            .then(() => {
                console.log('Token deleted');
                localStorage.removeItem('fcmToken');
                localStorage.removeItem('deviceId');
                showSuccessMessage('Notifications reset. Please re-enable them.');
                setupFirebaseAndNotifications(); // Restart the process
            })
            .catch(error => {
                console.error('Unable to delete token:', error);
            });
    }

    // Start setup when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        const preloader = document.getElementById('preloader');
        setTimeout(() => {
            preloader.style.display = 'none';
            setupFirebaseAndNotifications();
        }, 5000);
    });
</script>

    <!-- ✅ Reset notifications button -->
<!--     <button id="reset-notifications">Reset Notifications</button> -->
</body>
  </html>
